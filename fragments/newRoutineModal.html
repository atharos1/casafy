<div class="modal fade" id="newRoutineModal" tabindex="-1" role="dialog" aria-labelledby="createRoutineTitle"
 aria-hidden="true" data-backdrop="false">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="createRoutineTitle">Crear rutina</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="container" style="padding-bottom:30px;">
					<div class="row">
						<div class="col-md-3">*Nombre:
						</div>
						<div class="col-md-9">
							<input id="routineName" style="display:table-cell; width:100%" type="text" maxlength="25" placeholder="Nombre de la rutina" oninput="checkCorrectName()">
						</div>
					</div>
					<div class="row">
						<p id="wrongNameText" style="color: red; margin-left: 15px; margin-top: 5px;">El
							nombre debe contener al menos tres letras</p>
					</div>
					<div class="row">
						<div class="col-md-4">*Acciones: </div>
					</div>
					<div class="row">
						<div class="col-md-8">
							<div class="accordion" id="actionAccordion">
							</div>
						</div>
						<div class="col-md-4">
							<button type="button" class="btn btn-primary btn-sm" id="newActionBtn" data-toggle="modal" data-target="#newActionModal">Agregar</button>
							<button type="button" class="btn btn-primary btn-sm" id="deleteActionBtn">Eliminar</button>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" id="cancelRoutineBtn">Cancelar</button>
				<button type="button" class="btn btn-primary" id="createRoutineBtn" disabled>Guardar</button>
			</div>
		</div>
	</div>
</div>

<script>
	var actionInfo = [];

	function checkCorrectName() {
		let input = document.getElementById("routineName");
		let p = document.getElementById("wrongNameText");
		if (input.value.length < 3) {
			p.style.visibility = "visible";
		} else {
			p.style.visibility = "hidden";
		}
	}

	$('#routineName').on('input', function (event) {
		if ($('#routineName').val().length > 0 && $('#routineName').val().length < $('#routineName').attr("maxlength"))
			$("#createRoutineBtn").prop('disabled', false);
		else
			$("#createRoutineBtn").prop('disabled', true);
	});
	function getIndex(action) {
		for (var i = 0; i < actionInfo.length; i++) {
			if (actionInfo[i]["actionName"] === action["actionName"] &&
				actionInfo[i]["deviceId"] === action["deviceId"]) {
				return i;
			}
		}
		return -1;
	}
	function removeAction(action) {
		var cardId = "card" + action["actionName"] + action["deviceId"];
		$('#' + cardId).remove();
		var index = getIndex(action);
		actionInfo.splice(index, 1);
	}

	function addAction(action) {
		if (getIndex(action) != -1)
			removeAction(action);
		actionInfo.push(action);
		api.devices.get(action["deviceId"])
			.then(data => {
				var collapseId = action["actionName"] + action["deviceId"];
				var headerId = "header" + collapseId;
				var cardId = "card" + collapseId;
				$('#actionAccordion').append(
					'<div class="card" id="' + cardId + '">' +
					'<div class="card-header" id="' + headerId + '">' +
					'<h5 class="mb-0">' +
					'<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#' + collapseId + '" aria-expanded="true" aria-controls="' + collapseId + '">' +
					data["device"]["name"] + ": " + actionsTranslation[action["actionName"]] +
					'</button>' +
					'</h5>' +
					'</div>' +
					'<div id="' + collapseId + '" class="collapse" aria-labelledby="' + headerId + '" data-parent="#actionAccordion" ' +
					'actionName="' + action["actionName"] + '"deviceId="' + action["deviceId"] + '">' +
					'</div>' +
					'</div>');
				var cardBody = document.createElement("div");
				cardBody.setAttribute("class", "card-body");
				var container = document.createElement("div");
				container.setAttribute("class", "container");
				if (action["params"].length > 0) {
					for (paramNum in action["params"]) {
						var value;
						if (/^#[0-9A-F]{6}$/i.test(action["params"][paramNum]["value"]))
							value = '<div class="color-box" style="background-color:' + action["params"][paramNum]["value"] + '"></div>';
						else
							value = supportedValuesTranslation[action["params"][paramNum]["value"]] !== undefined ? supportedValuesTranslation[action["params"][paramNum]["value"]] : action["params"][paramNum]["value"];
						$(container).append(
							'<div class="row">' +
							'<div class="col-md-7">' +
							action["params"][paramNum]["name"] +
							':</div>' +
							'<div class="col-md-5">' +
							value +
							'</div>' +
							'</div>');
					}
				}
				else
					container.innerText = "No posee parametros.";
				$('#' + collapseId).append(cardBody);
				$(cardBody).append(container)
			}).catch(error => {
				alert("Request failed: " + error);
			});
	}

	$('#deleteActionBtn').on('click', function (event) {
		var selectedDevice = null;
		$('#actionAccordion').find("div").each(function (i) {
			console.log(this);
			if ($(this).hasClass("show"))
				selectedDevice = $(this);
		});
		if (selectedDevice == null)
			return;
		action = {
			deviceId: selectedDevice.attr("deviceId"),
			actionName: selectedDevice.attr("actionName")
		};
		removeAction(action);
	});

	$('#cancelRoutineBtn').on('click', function (event) {
		actionInfo = [];
		$('#actionAccordion').empty();
		$('#routineName').val("");
		$('#newRoutineModal').modal('hide');
	});

	$('#createRoutineBtn').on('click', function (event) {
		var name = $('#routineName').val();
		var actions = [];
		for (var i = 0; i < actionInfo.length; i++) {
			var deviceId = actionInfo[i]["deviceId"];
			var actionName = actionInfo[i]["actionName"];
			var params = [];
			for (paramNum in actionInfo[i]["params"])
				params.push(actionInfo[i]["params"][paramNum]["value"]);

			actions.push({
				deviceId: deviceId,
				actionName: actionName,
				params: params,
				meta: "{}"
			});
		}
		var newRoutine = {
			name: name,
			actions: actions,
			meta: "{}"
		}
		console.log(newRoutine);
		api.routines.create(newRoutine)
			.then(data => {
				alert("Rutina creada satisfactoriamente!");
				$('#newRoutineModal').modal('hide');
				$('#routineName').val("");
				populateRoutineTable();
			}).catch(error => {
				alert("Request failed: " + error);
			});
	});
</script>