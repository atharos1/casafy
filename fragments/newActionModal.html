<div class="modal fade" id="newActionModal" tabindex="-1" role="dialog" aria-labelledby="newActionTitle"
	aria-hidden="true" data-backdrop="false">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="newActionTitle">Añadir Acción</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<nav aria-label="breadcrumb">
				  <ol class="breadcrumb" id="routineBreadcrumb">
					
				  </ol>
				</nav>
				<div class="container">
					<div class="list-group" id="itemList" role="tablist">
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" data-dismiss="modal">Cancelar</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="getParamsModal" tabindex="-1" role="dialog" aria-labelledby="getParamsTitle"
	aria-hidden="true" data-backdrop="false">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="getParamsTitle">Parámetros</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="getParamsForm">
				</form>
				<div class="alert alert-warning alert-dismissible fade" role="alert" id="invalidParamAlert" style="display:none">
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" id="cancelParamsBtn">Cancelar</button>
				<button type="button" class="btn btn-primary" id="addActionBtn">Añadir</button>
			</div>
		</div>
	</div>
</div>
<script>
	var chosenRoomId = "";
	var chosenDeviceId = "";
	var actionsTranslation = {
		"up": "Subir",
		"down": "Bajar",
		"getState": "Ver estado",
		"turnOn": "Encender",
		"turnOff": "Apagar",
		"setColor": "Cambiar color",
		"setBrightness": "Cambiar brillo",
		"setTemperature": "Cambiar temperatura",
		"setHeat": "Elegir modo de calor",
		"setGrill": "Modo Grill",
		"setConvection": "Elegir convección",
		"setMode": "Elegir modo",
		"setVerticalSwing": "Oscilación vertical",
		"setHorizontalSwing": "Oscilación horizontal",
		"setFanSpeed": "Cambiar velocidad",
		"open": "Abrir",
		"close": "Cerrar",
		"lock": "Cerrar con llave",
		"unlock": "Abrir llave",
		"changeSecurityCode": "Cambiar código",
		"armStay": "Activar con personas dentro",
		"armAway": "Activar con personas fuera",
		"disarm": "Desactivar",
		"setInterval": "Tiempo de espera",
		"start": "Empezar",
		"stop": "Detener",
		"setFreezerTemperature": "Cambiar temperatura del congelador",
		
	}
	var paramsTranslation = {
		"brightness": "Brillo",
		"color": "Color",
		"temperature": "Temperatura",
		"heat": "Calor",
		"grill": "Grill",
		"convection": "Convección",
		"mode": "Modo",
		"verticalSwing": "Oscilación vertical",
		"horizontalSwing": "Oscilación horizontal",
		"fanSpeed": "Velocidad del ventilador",
		"oldSecurityCode": "Código viejo",
		"newSecurityCode": "Código nuevo",
		"securityCode": "Código de seguridad",
		"interval": "Intervalo"
	}
	var supportedValuesTranslation = {
		"auto": "Automático",
		"default": "Por defecto",
		"vacation": "Vacaciones",
		"party": "Fiesta",
		"normal": "Normal",
		"eco": "Ecológico",
		"off": "Apagado",
		"large": "Grande",
		"conventional": "Convencional",
		"top": "Arriba",
		"bottom": "Abajo",
		"cool": "Frío",
		"heat": "Calor",
		"fan": "Ventilador"
	}
	$('#newActionModal').on('show.bs.modal', function (event) {
		showRooms();
	});
	$('#cancelParamsBtn').on('click', function (event) {
		$('#invalidParamAlert').removeClass("show");
		$('#invalidParamAlert').attr("style","display:none");
		$('#getParamsModal').modal('hide');
	})
	$('#addActionBtn').on('click',function(event) {
		var actionName = $('#getParamsForm').attr("actionName");
		var paramNum = $('#getParamsForm').attr("params");
		var params = [];
		var valid = true;
		var alert = "";
		for(var i=1; i <= paramNum; i++) {
			if(!$('#param'+i).is("input")){
				if($('#param'+i).text() === "Seleccionar..."){
					alert += "Escoja el valor de " + $('#param'+i).attr("name") + "\n";
					valid = false;
				}
				else{
					params.push({
						name: paramsTranslation[$('#param'+i).attr("name")],
						value: $('#param'+i).attr("chosen")
					});
				}
				continue;
			}
			var maxDifference = $('#param'+i).val() - $('#param'+i).attr("max");
			var minDifference = $('#param'+i).val() - $('#param'+i).attr("min");
			if(maxDifference > 0 || minDifference < 0){
				alert += "El valor de " + $('#param'+i).attr("name") + " es inválido\n";
				valid = false;
			}
			else{
				params.push({
					name: paramsTranslation[$('#param'+i).attr("name")],
					value: $('#param'+i).val()
				});
			}
		}
		if(!valid){
			$('#invalidParamAlert').text(alert);
			$('#invalidParamAlert').addClass("show");
			$('#invalidParamAlert').attr("style","display:block;");
			return;
		}
		$('#getParamsModal').modal('hide');
		$('#newActionModal').modal('hide');
		var action = {
			actionName: actionName,
			deviceId: chosenDeviceId,
			params: params,
			meta: {}
		}
		//Funcion en newRoutineModal.html
		addAction(action);
	});
	function chooseAction(actionElem) {
		var actionName = $(actionElem).attr("actionName");
		$('#getParamsForm').empty();
		$('#getParamsForm').attr("actionName",actionName);
		showParams(actionName);
	}
	function showRooms() {
		$('#routineBreadcrumb').empty();
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showRooms()">Habitaciones</li>');
		var itemList = $('#itemList');
		itemList.empty();
		api.rooms.getAll()
				.then(data => {
					var rooms = data["rooms"];
					for(roomNum in rooms)
						itemList.append('<a class="list-group-item list-group-item-action" onClick="showDevices(\'' + rooms[roomNum]["id"] + '\')" data-toggle="list">'+ rooms[roomNum]["name"] +'</a>');
						
				}).catch(error => {
					alert("Request failed: " + error);
				});
	}
	function showDevices(roomId) {
		chosenRoomId = roomId;
		$('#routineBreadcrumb').empty();
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showRooms()">Habitaciones</li>');
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showDevices(\''+ roomId +'\')">Dispositivos</li>');
		var itemList = $('#itemList');
		itemList.empty();
		api.get(api.rooms.url + roomId + "/devices")
			.then(data => {
				var devices = data["devices"];
				for(deviceNum in devices)
					itemList.append('<a class="list-group-item list-group-item-action" onClick="showActions(\'' + devices[deviceNum]["id"] +'\')"data-toggle="list">'+ devices[deviceNum]["name"] +'</a>');
			
			}).catch(error => {
				alert("Request failed: " + error);
			});
	}
	function showActions(deviceId) {
		chosenDeviceId = deviceId;
		$('#routineBreadcrumb').empty();
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showRooms()">Habitaciones</li>');
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showDevices(\''+ chosenRoomId +'\')">Dispositivos</li>');
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showActions(\'' + deviceId + '\')">Acciones</li>');
		var typeId;
		api.devices.get(deviceId)
			.then(data => {
				typeId = data["device"]["typeId"];
			}).catch(error => {
				alert("Request failed: " + error);
			}).then(data => {
				var itemList = $('#itemList');
				itemList.empty();
				api.get(api.baseUrl + "devicetypes/" + typeId)
					.then(data => {
						var deviceActions = data["device"]["actions"];
						for(actionNum in deviceActions)
							itemList.append('<a class="list-group-item list-group-item-action" actionName="'+ deviceActions[actionNum]["name"]+
								'"onClick="chooseAction(this)">'+ actionsTranslation[deviceActions[actionNum]["name"]] +'</a>');
					}).catch(error => {
						alert("Request failed: " + error);
					});
			}).catch(error => {
				alert("Request failed: " + error);
			});
	}
	function showParams(actionName) {
		var typeId;
		api.devices.get(chosenDeviceId)
				.then(data => {
					typeId = data["device"]["typeId"];
				}).catch(error => {
					alert("Request failed: " + error);
				}).then(data => {
					api.fetch(api.baseUrl + "devicetypes/" + typeId)
						.then(data => {
							var actions = data["device"]["actions"];
							var params = null;
							for(actionNum in actions){
								if (actions[actionNum]["name"].toLowerCase() === actionName.toLowerCase()){
									params = actions[actionNum]["params"];
									break;
								}
							}
							var i = 0;
							if(params != null && params.length > 0){
								for(paramNum in params){
									++i;
									if(params[paramNum]["supportedValues"] !== undefined){
										$('#getParamsForm').append(
											"<div class=\"form-group-row\">" +
												"<div class=\"col-md-6\">" + paramsTranslation[params[paramNum]["name"]] + ":</div>" + 	
												"<div class=\"col-md-6\">"  +
													"<div class=\"d-inline dropdown\" id=\"deviceTypeBtn\">" +
														"<button class=\"btn btn-secondary dropdown-toggle btn-sm\" type=\"button\"" +
															"id=\"param"+i+"\" name=\""+params[paramNum]["name"]+"\" data-toggle=\"dropdown\" aria-haspopup=\"true\"" +
															"aria-expanded=\"false\" style=\"display:inline;\">Seleccionar...</button>" +
														"<div class=\"dropdown-menu\" aria-labelledby=\"dropdownMenuButton\" id=\"supportedValues\">" +
														"</div>" +
													"</div>" +
												"</div>" +
											"</div>");
										for(var j=0 ; j < params[paramNum]["supportedValues"].length; j++){
											var value = params[paramNum]["supportedValues"][j];
											$('#supportedValues').append(
												"<button class=\"dropdown-item btn-sm\" id=\""+ value +"\"type=\"button\" onClick=\"updateDropdown(this,"+i+")\">" + 
													(isNaN(value) ? supportedValuesTranslation[value] : value) + "</button>");
										}
										continue;
									}
									var placeholderString = "Valor max: " + params[paramNum]["maxValue"] + " | Valor min: " + params[paramNum]["minValue"];
									var input = document.createElement('input');
									input.id = "param" + i;
									if(params[paramNum]["type"] === "integer" || params[paramNum]["type"] === "number")
										input.setAttribute("type","number");
									else 
										input.setAttribute("type","text");
									input.setAttribute("style","display:table-cell; width:100%");
									input.setAttribute("max",params[paramNum]["maxValue"]);
									input.setAttribute("min",params[paramNum]["minValue"]);
									input.setAttribute("placeholder",placeholderString);
									input.setAttribute("name",params[paramNum]["name"]);
									$('#getParamsForm').append(
										"<div class=\"form-group row\">" +
											"<div class=\"col-md-4\">" + paramsTranslation[params[paramNum]["name"]] + ":</div>" + 	
											"<div class=\"col-md-8\" id=\"param"+ i + "container\">" +
											"</div>" +
										"</div>");
									$('#param'+i+'container').append(input);
								}
							}
							$('#getParamsForm').attr('params',i);
							
							if(params != null && params.length > 0)
								$('#getParamsModal').modal('show');
							else
								$('#addActionBtn').click();
						}).catch(error => {
							alert("Request failed: " + error);
						});
				}).catch(error => {
					alert("Request failed: " + error);
				});
	}
	function updateDropdown(chosenElem,paramNum){
		$('#param'+paramNum).attr('chosen',$(chosenElem).attr('id'));
		$('#param'+paramNum).text($(chosenElem).text());
	}
	$('#cancelActionBtn').on('click', function(event) {
		$('#newActionModal').modal('hide')
	});
</script>