<div class="modal fade" id="newActionModal" tabindex="-1" role="dialog" aria-labelledby="newActionTitle"
	aria-hidden="true" data-backdrop="false">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="newActionTitle">Añadir Acción</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<nav aria-label="breadcrumb">
				  <ol class="breadcrumb" id="routineBreadcrumb">
					
				  </ol>
				</nav>
				<div class="container">
					<div class="list-group" id="itemList" role="tablist" style="height: 300px;max-height:300px; border:3px solid #cecece;overflow:auto;">
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-primary" id="cancelActionBtn">Cancelar</button>
			</div>
		</div>
	</div>
</div>
<div class="modal fade" id="getParamsModal" tabindex="-1" role="dialog" aria-labelledby="getParamsTitle"
	aria-hidden="true" data-backdrop="false">
	<div class="modal-dialog modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="getParamsTitle">Añadir Acción</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="getParamsForm">
					<div class="form-group row" style="padding-bottom:10px">
						<div class="col-md-5">Nombre:</div>
						<div class="col-md-7">
							<input id="actionName" type="text"><br>
						</div>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" id="cancelActionBtn">Cancelar</button>
				<button type="button" class="btn btn-primary">Añadir</button>
			</div>
		</div>
	</div>
</div>
<script>
	$('#newActionModal').on('show.bs.modal', function (event) {
		showRooms();
	});
	$('#getParamsModal').on('show.bs.modal', function (event) {
		
		var actionName = $(event.relatedTarget).text();
		var deviceId = $(event.relatedTarget).attr("deviceId");
		var typeId;
		$('#getParamsForm').empty();
		$('#getParamsForm').append(
					"<div class=\"form-group row\" style=\"padding-bottom:10px\">" +
						"<div class=\"col-md-5\">Nombre:</div>" +
						"<div class=\"col-md-7\">" +
							"<input id=\"actionName\" type=\"text\"><br>" +
						"</div>" +
					"</div>");
		api.devices.get(deviceId)
			.then(data => {
				typeId = data["device"]["typeId"];
			}).catch(error => {
				alert("Request failed: " + error);
			}).then(data => {
				api.fetch(api.baseUrl + "devicetypes/" + typeId)
					.then(data => {
						var actions = data["device"]["actions"];
						var params = null;
						for(actionNum in actions){
							if (actions[actionNum]["name"].toLowerCase() === actionName.toLowerCase()){
								params = actions[actionNum]["params"];
								break;
							}
						}
						console.log(params);
						if(params != null){
							for(paramNum in params){
								$('#getParamsForm').append(
									"<div class=\"form-group row\">" +
										"<div class=\"col-md-5\">" + params[paramNum]["name"] + "</div>" + 	
										"<div class=\"col-md-7\">" +
											"<input style=\"display:table-cell; width:100%\" id=\"" + params[paramNum]["name"] + "\" type=\"text\" placeholder=\"" + 
											"Valor max: " + params[paramNum]["maxValue"] + " | Valor min: " + params[paramNum]["minValue"] + "\"><br>" +
										"</div>" +
									"</div>");
							}
						}
					}).catch(error => {
						alert("Request failed: " + error);
					});
			}).catch(error => {
				alert("Request failed: " + error);
			});
	});
	function showRooms() {
		$('#routineBreadcrumb').empty();
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showRooms()">Habitaciones</li>');
		var itemList = $('#itemList');
		itemList.empty();
		api.rooms.getAll()
				.then(data => {
					var rooms = data["rooms"];
					for(roomNum in rooms)
						itemList.append('<a class="list-group-item list-group-item-action" onClick="showDevices(\'' + rooms[roomNum]["id"] + '\')" data-toggle="list">'+ rooms[roomNum]["name"] +'</a>');
						
				}).catch(error => {
					alert("Request failed: " + error);
				});
	}
	var chosenRoomId = "";
	function showDevices(roomId) {
		chosenRoomId = roomId;
		$('#routineBreadcrumb').empty();
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showRooms()">Habitaciones</li>');
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showDevices(\''+ roomId +'\')">Dispositivos</li>');
		var itemList = $('#itemList');
		itemList.empty();
		api.get(api.rooms.url + roomId + "/devices")
			.then(data => {
				var devices = data["devices"];
				for(deviceNum in devices)
					itemList.append('<a class="list-group-item list-group-item-action" onClick="showActions(\'' + devices[deviceNum]["id"] +'\')"data-toggle="list">'+ devices[deviceNum]["name"] +'</a>');
			
			}).catch(error => {
				alert("Request failed: " + error);
			});
	}
	function showActions(deviceId) {
		$('#routineBreadcrumb').empty();
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showRooms()">Habitaciones</li>');
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showDevices(\''+ chosenRoomId +'\')">Dispositivos</li>');
		$('#routineBreadcrumb').append('<li class="breadcrumb-item" onClick="showActions(\'' + deviceId + '\')">Acciones</li>');
		var typeId;
		api.devices.get(deviceId)
			.then(data => {
				typeId = data["device"]["typeId"];
			}).catch(error => {
				alert("Request failed: " + error);
			}).then(data => {
				var itemList = $('#itemList');
				itemList.empty();
				api.get(api.baseUrl + "devicetypes/" + typeId,false)
					.then(data => {
						var deviceActions = data["device"]["actions"];
						for(actionNum in deviceActions)
							itemList.append('<a class="list-group-item list-group-item-action" data-toggle="modal" data-target="#getParamsModal" deviceId="'+ deviceId +'">'+ deviceActions[actionNum]["name"] +'</a>');
					}).catch(error => {
						alert("Request failed: " + error);
					});
			}).catch(error => {
				alert("Request failed: " + error);
			});
	}
	$('#cancelActionBtn').on('click', function(event) {
		$('#newActionModal').modal('hide')
	});
</script>